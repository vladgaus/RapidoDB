# Benchmark Workflow
# Compares RapidoDB vs LevelDB vs RocksDB vs Redis
#
# Triggers:
#   - Manual: Actions tab -> "Run workflow"
#   - Weekly: Every Sunday at 00:00 UTC
#   - On release tags
#
# Results are uploaded as artifacts and posted to PR comments

name: Benchmark

on:
  # Manual trigger with customizable parameters
  workflow_dispatch:
    inputs:
      num_ops:
        description: 'Number of operations'
        required: false
        default: '100000'
      value_size:
        description: 'Value size in bytes'
        required: false
        default: '100'
      compare_dbs:
        description: 'Compare with other databases'
        required: false
        default: true
        type: boolean

  # Run weekly on Sunday
  schedule:
    - cron: '0 0 * * 0'

  # Run on release tags
  push:
    tags:
      - 'v*'

  # Optional: Run on PRs with [benchmark] in title
  pull_request:
    types: [opened, synchronize]

env:
  GO_VERSION: '1.22'
  NUM_OPS: ${{ github.event.inputs.num_ops || '100000' }}
  VALUE_SIZE: ${{ github.event.inputs.value_size || '100' }}

# Required for PR comments
permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================================================
  # RapidoDB Benchmark
  # ============================================================================
  rapidodb:
    name: RapidoDB Benchmark
    runs-on: ubuntu-latest
    outputs:
      fillseq: ${{ steps.parse.outputs.fillseq }}
      fillrandom: ${{ steps.parse.outputs.fillrandom }}
      readseq: ${{ steps.parse.outputs.readseq }}
      readrandom: ${{ steps.parse.outputs.readrandom }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build RapidoDB
        run: |
          go build -o rapidodb-bench ./cmd/bench
          
      - name: Run Benchmark
        run: |
          ./rapidodb-bench --mode all --num ${{ env.NUM_OPS }} --value-size ${{ env.VALUE_SIZE }} 2>&1 | tee rapidodb-results.txt

      - name: Parse Results
        id: parse
        run: |
          # Extract ops/sec for each workload from the comparison table
          FILLSEQ=$(grep "fillseq" rapidodb-results.txt | grep -oP '\d+(?=\s+\d+\.\d+\s+\d+\.\d+\s+\d+\.\d+ â•‘)' | head -1 || echo "N/A")
          FILLRANDOM=$(grep "fillrandom" rapidodb-results.txt | grep -oP '\d+(?=\s+\d+\.\d+\s+\d+\.\d+\s+\d+\.\d+ â•‘)' | head -1 || echo "N/A")
          READSEQ=$(grep "readseq" rapidodb-results.txt | grep -oP '\d+(?=\s+\d+\.\d+\s+\d+\.\d+\s+\d+\.\d+ â•‘)' | head -1 || echo "N/A")
          READRANDOM=$(grep "readrandom" rapidodb-results.txt | grep -oP '\d+(?=\s+\d+\.\d+\s+\d+\.\d+\s+\d+\.\d+ â•‘)' | head -1 || echo "N/A")
          
          echo "fillseq=$FILLSEQ" >> $GITHUB_OUTPUT
          echo "fillrandom=$FILLRANDOM" >> $GITHUB_OUTPUT
          echo "readseq=$READSEQ" >> $GITHUB_OUTPUT
          echo "readrandom=$READRANDOM" >> $GITHUB_OUTPUT
          
          echo "### RapidoDB Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat rapidodb-results.txt >> $GITHUB_STEP_SUMMARY

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: rapidodb-results
          path: rapidodb-results.txt

  # ============================================================================
  # Redis Benchmark (in-memory baseline)
  # ============================================================================
  redis:
    name: Redis Benchmark
    runs-on: ubuntu-latest
    continue-on-error: true
    if: github.event.inputs.compare_dbs != 'false'
    outputs:
      fillseq: ${{ steps.parse.outputs.fillseq }}
      fillrandom: ${{ steps.parse.outputs.fillrandom }}
      readseq: ${{ steps.parse.outputs.readseq }}
      readrandom: ${{ steps.parse.outputs.readrandom }}
    steps:
      - name: Install Redis
        run: |
          sudo apt-get update
          sudo apt-get install -y redis-server redis-tools

      - name: Start Redis with Persistence
        run: |
          # Run Redis with AOF persistence enabled (fair comparison)
          redis-server --daemonize yes --appendonly yes --appendfsync everysec
          sleep 2
          redis-cli ping

      - name: Run Benchmark
        run: |
          # Redis benchmark with pipelining for realistic throughput
          # -P 16 = send 16 commands at once (typical production usage)
          # Note: Redis is in-memory + network, others are embedded disk-based
          
          echo "=== Redis SET (write) benchmark ===" | tee redis-results.txt
          redis-benchmark -t set -n ${{ env.NUM_OPS }} -d ${{ env.VALUE_SIZE }} -P 16 --csv 2>&1 | tee -a redis-results.txt
          
          echo "" >> redis-results.txt
          echo "=== Redis GET (read) benchmark ===" >> redis-results.txt
          redis-benchmark -t get -n ${{ env.NUM_OPS }} -d ${{ env.VALUE_SIZE }} -P 16 --csv 2>&1 | tee -a redis-results.txt
          
          echo "" >> redis-results.txt
          echo "=== Redis Single-Request Latency (no pipelining) ===" >> redis-results.txt
          redis-benchmark -t set,get -n 10000 -d ${{ env.VALUE_SIZE }} -P 1 --csv 2>&1 | tee -a redis-results.txt

      - name: Parse Results
        id: parse
        run: |
          # Redis CSV format: "TEST","RPS","AVG_LATENCY_MS","MIN_LATENCY_MS","P50","P95","P99","MAX_LATENCY_MS"
          # Extract RPS (requests per second) for SET and GET
          
          echo "=== Redis Raw Output ==="
          cat redis-results.txt
          echo "========================"
          
          # Extract SET ops/s (fillrandom equivalent)
          FILLRANDOM=$(grep '"SET"' redis-results.txt | head -1 | cut -d',' -f2 | tr -d '"' || echo "N/A")
          # For fillseq, use same as fillrandom (Redis doesn't distinguish)
          FILLSEQ=$FILLRANDOM
          
          # Extract GET ops/s (readrandom equivalent)
          READRANDOM=$(grep '"GET"' redis-results.txt | head -1 | cut -d',' -f2 | tr -d '"' || echo "N/A")
          # For readseq, use same as readrandom (Redis doesn't have sequential read)
          READSEQ=$READRANDOM
          
          echo "DEBUG: FILLSEQ=$FILLSEQ FILLRANDOM=$FILLRANDOM READSEQ=$READSEQ READRANDOM=$READRANDOM"
          
          echo "fillseq=$FILLSEQ" >> $GITHUB_OUTPUT
          echo "fillrandom=$FILLRANDOM" >> $GITHUB_OUTPUT
          echo "readseq=$READSEQ" >> $GITHUB_OUTPUT
          echo "readrandom=$READRANDOM" >> $GITHUB_OUTPUT
          
          echo "### Redis Results (with AOF persistence)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Operation | ops/s |" >> $GITHUB_STEP_SUMMARY
          echo "|:----------|------:|" >> $GITHUB_STEP_SUMMARY
          echo "| SET (write) | $FILLRANDOM |" >> $GITHUB_STEP_SUMMARY
          echo "| GET (read) | $READRANDOM |" >> $GITHUB_STEP_SUMMARY

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: redis-results
          path: redis-results.txt

  # ============================================================================
  # LevelDB Benchmark (optional)
  # ============================================================================
  leveldb:
    name: LevelDB Benchmark
    runs-on: ubuntu-latest
    continue-on-error: true
    if: github.event.inputs.compare_dbs != 'false'
    outputs:
      fillseq: ${{ steps.parse.outputs.fillseq }}
      fillrandom: ${{ steps.parse.outputs.fillrandom }}
      readseq: ${{ steps.parse.outputs.readseq }}
      readrandom: ${{ steps.parse.outputs.readrandom }}
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake bc

      - name: Cache LevelDB
        id: cache-leveldb
        uses: actions/cache@v4
        with:
          path: leveldb
          key: leveldb-build-v1.23-full-${{ runner.os }}

      - name: Build LevelDB
        if: steps.cache-leveldb.outputs.cache-hit != 'true'
        run: |
          # Clone WITHOUT --depth 1 to properly fetch submodules
          git clone --branch 1.23 https://github.com/google/leveldb.git
          cd leveldb
          git submodule update --init --recursive
          mkdir -p build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_CXX_STANDARD=17 \
                -DLEVELDB_BUILD_TESTS=ON \
                -DLEVELDB_BUILD_BENCHMARKS=ON ..
          make db_bench -j$(nproc)

      - name: Run Benchmark
        run: |
          cd leveldb/build
          # Run fill first, then reads on same DB
          ./db_bench --benchmarks=fillseq,readrandom,readseq \
                     --num=${{ env.NUM_OPS }} \
                     --value_size=${{ env.VALUE_SIZE }} 2>&1 | tee ../../leveldb-results.txt
          # Run fillrandom separately
          ./db_bench --benchmarks=fillrandom \
                     --num=${{ env.NUM_OPS }} \
                     --value_size=${{ env.VALUE_SIZE }} 2>&1 | tee -a ../../leveldb-results.txt

      - name: Parse Results
        id: parse
        run: |
          # LevelDB outputs "micros/op" not "ops/s", so we need to convert
          # Format varies:
          #   fillseq      :       2.495 micros/op;   44.3 MB/s
          #   readrandom   :       1.308 micros/op; (100000 of 100000 found)
          
          echo "=== LevelDB Raw Output ===" 
          cat leveldb-results.txt
          echo "=========================="
          
          extract_ops() {
            local bench=$1
            # Find line containing benchmark name, extract number before "micros/op"
            local micros=$(grep "$bench" leveldb-results.txt | grep "micros/op" | awk -F':' '{print $2}' | awk '{print $1}' | head -1)
            echo "DEBUG $bench: micros='$micros'" >&2
            
            if [ -n "$micros" ] && [ "$micros" != "0" ]; then
              # Convert micros/op to ops/s: 1,000,000 / micros
              local ops=$(echo "scale=0; 1000000 / $micros" | bc 2>/dev/null)
              if [ -n "$ops" ]; then
                echo "$ops"
              else
                echo "N/A"
              fi
            else
              echo "N/A"
            fi
          }
          
          FILLSEQ=$(extract_ops "fillseq")
          FILLRANDOM=$(extract_ops "fillrandom")
          READSEQ=$(extract_ops "readseq")
          READRANDOM=$(extract_ops "readrandom")
          
          echo "DEBUG: FILLSEQ=$FILLSEQ FILLRANDOM=$FILLRANDOM READSEQ=$READSEQ READRANDOM=$READRANDOM" >&2
          
          echo "fillseq=$FILLSEQ" >> $GITHUB_OUTPUT
          echo "fillrandom=$FILLRANDOM" >> $GITHUB_OUTPUT
          echo "readseq=$READSEQ" >> $GITHUB_OUTPUT
          echo "readrandom=$READRANDOM" >> $GITHUB_OUTPUT
          
          echo "### LevelDB Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Benchmark | ops/s |" >> $GITHUB_STEP_SUMMARY
          echo "|:----------|------:|" >> $GITHUB_STEP_SUMMARY
          echo "| fillseq | $FILLSEQ |" >> $GITHUB_STEP_SUMMARY
          echo "| fillrandom | $FILLRANDOM |" >> $GITHUB_STEP_SUMMARY
          echo "| readseq | $READSEQ |" >> $GITHUB_STEP_SUMMARY
          echo "| readrandom | $READRANDOM |" >> $GITHUB_STEP_SUMMARY

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: leveldb-results
          path: leveldb-results.txt

  # ============================================================================
  # RocksDB Benchmark (optional) - with improved caching
  # ============================================================================
  rocksdb:
    name: RocksDB Benchmark
    runs-on: ubuntu-latest
    continue-on-error: true
    if: github.event.inputs.compare_dbs != 'false'
    outputs:
      fillseq: ${{ steps.parse.outputs.fillseq }}
      fillrandom: ${{ steps.parse.outputs.fillrandom }}
      readseq: ${{ steps.parse.outputs.readseq }}
      readrandom: ${{ steps.parse.outputs.readrandom }}
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libgflags-dev libsnappy-dev \
               zlib1g-dev libbz2-dev liblz4-dev libzstd-dev

      - name: Cache RocksDB Build
        id: cache-rocksdb
        uses: actions/cache@v4
        with:
          path: rocksdb
          key: rocksdb-v8.10.0-release-${{ runner.os }}-v2

      - name: Build RocksDB
        if: steps.cache-rocksdb.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch v8.10.0 https://github.com/facebook/rocksdb.git
          cd rocksdb
          # Build in RELEASE mode (DEBUG_LEVEL=0) for faster build and accurate benchmarks
          DEBUG_LEVEL=0 PORTABLE=1 make db_bench -j$(nproc)

      - name: Run Benchmark
        run: |
          cd rocksdb
          ./db_bench --benchmarks=fillseq,fillrandom,readseq,readrandom \
                     --num=${{ env.NUM_OPS }} \
                     --value_size=${{ env.VALUE_SIZE }} 2>&1 | tee ../rocksdb-results.txt

      - name: Parse Results
        id: parse
        run: |
          FILLSEQ=$(grep "^fillseq" rocksdb-results.txt | awk '{print $5}' || echo "N/A")
          FILLRANDOM=$(grep "^fillrandom" rocksdb-results.txt | awk '{print $5}' || echo "N/A")
          READSEQ=$(grep "^readseq" rocksdb-results.txt | awk '{print $5}' || echo "N/A")
          READRANDOM=$(grep "^readrandom" rocksdb-results.txt | awk '{print $5}' || echo "N/A")
          
          echo "fillseq=$FILLSEQ" >> $GITHUB_OUTPUT
          echo "fillrandom=$FILLRANDOM" >> $GITHUB_OUTPUT
          echo "readseq=$READSEQ" >> $GITHUB_OUTPUT
          echo "readrandom=$READRANDOM" >> $GITHUB_OUTPUT
          
          echo "### RocksDB Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Benchmark | ops/s |" >> $GITHUB_STEP_SUMMARY
          echo "|:----------|------:|" >> $GITHUB_STEP_SUMMARY
          echo "| fillseq | $FILLSEQ |" >> $GITHUB_STEP_SUMMARY
          echo "| fillrandom | $FILLRANDOM |" >> $GITHUB_STEP_SUMMARY
          echo "| readseq | $READSEQ |" >> $GITHUB_STEP_SUMMARY
          echo "| readrandom | $READRANDOM |" >> $GITHUB_STEP_SUMMARY

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: rocksdb-results
          path: rocksdb-results.txt

  # ============================================================================
  # Summary Report
  # ============================================================================
  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [rapidodb, redis, leveldb, rocksdb]
    if: always() && needs.rapidodb.result == 'success'
    steps:
      - name: Download All Results
        uses: actions/download-artifact@v4
        with:
          path: results

      - name: Generate Comparison Report
        run: |
          echo "# ðŸ“Š Benchmark Comparison Report" > report.md
          echo "" >> report.md
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> report.md
          echo "**Operations:** ${{ env.NUM_OPS }}" >> report.md
          echo "**Value Size:** ${{ env.VALUE_SIZE }} bytes" >> report.md
          echo "**Runner:** GitHub Actions (ubuntu-latest)" >> report.md
          echo "" >> report.md
          
          echo "## Results Summary" >> report.md
          echo "" >> report.md
          echo "| Workload | RapidoDB | Redis* | LevelDB | RocksDB |" >> report.md
          echo "|:---------|:---------|:-------|:--------|:--------|" >> report.md
          echo "| fillseq | ${{ needs.rapidodb.outputs.fillseq }} | ${{ needs.redis.outputs.fillseq }} | ${{ needs.leveldb.outputs.fillseq }} | ${{ needs.rocksdb.outputs.fillseq }} |" >> report.md
          echo "| fillrandom | ${{ needs.rapidodb.outputs.fillrandom }} | ${{ needs.redis.outputs.fillrandom }} | ${{ needs.leveldb.outputs.fillrandom }} | ${{ needs.rocksdb.outputs.fillrandom }} |" >> report.md
          echo "| readseq | ${{ needs.rapidodb.outputs.readseq }} | ${{ needs.redis.outputs.readseq }} | ${{ needs.leveldb.outputs.readseq }} | ${{ needs.rocksdb.outputs.readseq }} |" >> report.md
          echo "| readrandom | ${{ needs.rapidodb.outputs.readrandom }} | ${{ needs.redis.outputs.readrandom }} | ${{ needs.leveldb.outputs.readrandom }} | ${{ needs.rocksdb.outputs.readrandom }} |" >> report.md
          echo "" >> report.md
          echo "_*Redis with AOF persistence + pipelining (P=16). Note: Redis is in-memory with network access; others are embedded disk-based._" >> report.md
          echo "" >> report.md
          
          echo "## Database Comparison" >> report.md
          echo "" >> report.md
          echo "| Feature | RapidoDB | Redis | LevelDB | RocksDB |" >> report.md
          echo "|:--------|:--------:|:-----:|:-------:|:-------:|" >> report.md
          echo "| Storage | Disk (LSM) | In-Memory | Disk (LSM) | Disk (LSM) |" >> report.md
          echo "| Language | Go | C | C++ | C++ |" >> report.md
          echo "| Dependencies | **0** | 3+ | 2 | 20+ |" >> report.md
          echo "| Data > RAM | âœ… | âŒ | âœ… | âœ… |" >> report.md
          echo "| Always Persistent | âœ… | Optional | âœ… | âœ… |" >> report.md
          echo "" >> report.md
          
          echo "## Notes" >> report.md
          echo "" >> report.md
          echo "- **RapidoDB**: Zero dependencies, 4MB binary, 5-second build, pure Go" >> report.md
          echo "- **Redis**: In-memory (fastest), limited by RAM size" >> report.md
          echo "- **LevelDB**: Original LSM implementation by Google" >> report.md
          echo "- **RocksDB**: Highly optimized, 20+ dependencies, long build time" >> report.md
          echo "- Results may vary based on GitHub Actions runner availability" >> report.md
          echo "" >> report.md
          
          echo "## Full Results" >> report.md
          echo "" >> report.md
          
          for db in rapidodb redis leveldb rocksdb; do
            if [ -f "results/${db}-results/${db}-results.txt" ]; then
              echo "<details>" >> report.md
              echo "<summary>${db^} Full Output</summary>" >> report.md
              echo "" >> report.md
              echo '```' >> report.md
              cat "results/${db}-results/${db}-results.txt" >> report.md
              echo '```' >> report.md
              echo "</details>" >> report.md
              echo "" >> report.md
            fi
          done
          
          cat report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-report
          path: report.md

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Benchmark Comparison Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }

  # ============================================================================
  # Quick Benchmark (RapidoDB only, for PRs)
  # ============================================================================
  quick-bench:
    name: Quick Benchmark
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && !contains(github.event.pull_request.title, '[full-benchmark]')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build and Run Quick Benchmark
        run: |
          go build -o rapidodb-bench ./cmd/bench
          echo "### Quick Benchmark (10K ops)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ./rapidodb-bench --mode all --num 10000 2>&1 | tee -a $GITHUB_STEP_SUMMARY
