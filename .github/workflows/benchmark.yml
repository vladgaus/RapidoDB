# Benchmark Workflow
# Compares RapidoDB vs LevelDB vs RocksDB
#
# Triggers:
#   - Manual: Actions tab -> "Run workflow"
#   - Weekly: Every Sunday at 00:00 UTC
#   - On release tags
#
# Results are uploaded as artifacts and posted to PR comments

name: Benchmark

on:
  # Manual trigger with customizable parameters
  workflow_dispatch:
    inputs:
      num_ops:
        description: 'Number of operations'
        required: false
        default: '100000'
      value_size:
        description: 'Value size in bytes'
        required: false
        default: '100'
      compare_dbs:
        description: 'Compare with LevelDB/RocksDB'
        required: false
        default: true
        type: boolean

  # Run weekly on Sunday
  schedule:
    - cron: '0 0 * * 0'

  # Run on release tags
  push:
    tags:
      - 'v*'

  # Optional: Run on PRs with [benchmark] in title
  pull_request:
    types: [opened, synchronize]

env:
  GO_VERSION: '1.22'
  NUM_OPS: ${{ github.event.inputs.num_ops || '100000' }}
  VALUE_SIZE: ${{ github.event.inputs.value_size || '100' }}

# Required for PR comments
permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================================================
  # RapidoDB Benchmark
  # ============================================================================
  rapidodb:
    name: RapidoDB Benchmark
    runs-on: ubuntu-latest
    outputs:
      fillseq: ${{ steps.parse.outputs.fillseq }}
      fillrandom: ${{ steps.parse.outputs.fillrandom }}
      readseq: ${{ steps.parse.outputs.readseq }}
      readrandom: ${{ steps.parse.outputs.readrandom }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build RapidoDB
        run: |
          go build -o rapidodb-bench ./cmd/bench
          
      - name: Run Benchmark
        run: |
          ./rapidodb-bench --mode all --num ${{ env.NUM_OPS }} --value-size ${{ env.VALUE_SIZE }} 2>&1 | tee rapidodb-results.txt

      - name: Parse Results
        id: parse
        run: |
          # Extract ops/sec for each workload from the comparison table
          FILLSEQ=$(grep "fillseq" rapidodb-results.txt | grep -oP '\d+(?=\s+\d+\.\d+\s+\d+\.\d+\s+\d+\.\d+ â•‘)' | head -1 || echo "N/A")
          FILLRANDOM=$(grep "fillrandom" rapidodb-results.txt | grep -oP '\d+(?=\s+\d+\.\d+\s+\d+\.\d+\s+\d+\.\d+ â•‘)' | head -1 || echo "N/A")
          READSEQ=$(grep "readseq" rapidodb-results.txt | grep -oP '\d+(?=\s+\d+\.\d+\s+\d+\.\d+\s+\d+\.\d+ â•‘)' | head -1 || echo "N/A")
          READRANDOM=$(grep "readrandom" rapidodb-results.txt | grep -oP '\d+(?=\s+\d+\.\d+\s+\d+\.\d+\s+\d+\.\d+ â•‘)' | head -1 || echo "N/A")
          
          echo "fillseq=$FILLSEQ" >> $GITHUB_OUTPUT
          echo "fillrandom=$FILLRANDOM" >> $GITHUB_OUTPUT
          echo "readseq=$READSEQ" >> $GITHUB_OUTPUT
          echo "readrandom=$READRANDOM" >> $GITHUB_OUTPUT
          
          echo "### RapidoDB Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat rapidodb-results.txt >> $GITHUB_STEP_SUMMARY

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: rapidodb-results
          path: rapidodb-results.txt

  # ============================================================================
  # LevelDB Benchmark (optional)
  # ============================================================================
  leveldb:
    name: LevelDB Benchmark
    runs-on: ubuntu-latest
    continue-on-error: true
    if: github.event.inputs.compare_dbs != 'false'
    outputs:
      fillseq: ${{ steps.parse.outputs.fillseq }}
      fillrandom: ${{ steps.parse.outputs.fillrandom }}
      readseq: ${{ steps.parse.outputs.readseq }}
      readrandom: ${{ steps.parse.outputs.readrandom }}
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake bc

      - name: Cache LevelDB
        id: cache-leveldb
        uses: actions/cache@v4
        with:
          path: leveldb
          key: leveldb-build-v1.23-full-${{ runner.os }}

      - name: Build LevelDB
        if: steps.cache-leveldb.outputs.cache-hit != 'true'
        run: |
          # Clone WITHOUT --depth 1 to properly fetch submodules
          git clone --branch 1.23 https://github.com/google/leveldb.git
          cd leveldb
          git submodule update --init --recursive
          mkdir -p build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_CXX_STANDARD=17 \
                -DLEVELDB_BUILD_TESTS=ON \
                -DLEVELDB_BUILD_BENCHMARKS=ON ..
          make db_bench -j$(nproc)

      - name: Run Benchmark
        run: |
          cd leveldb/build
          # Run fill first, then reads on same DB
          # Note: LevelDB clears DB between benchmarks by default
          ./db_bench --benchmarks=fillseq,readrandom,readseq \
                     --num=${{ env.NUM_OPS }} \
                     --value_size=${{ env.VALUE_SIZE }} 2>&1 | tee ../../leveldb-results.txt
          # Run fillrandom separately
          ./db_bench --benchmarks=fillrandom \
                     --num=${{ env.NUM_OPS }} \
                     --value_size=${{ env.VALUE_SIZE }} 2>&1 | tee -a ../../leveldb-results.txt

      - name: Parse Results
        id: parse
        run: |
          # LevelDB outputs "micros/op" not "ops/s", so we need to convert
          # Format: "fillseq      :       2.843 micros/op;   35.2 MB/s"
          # Note: benchmark names may have leading spaces, so don't use ^
          
          echo "=== LevelDB Raw Output ===" 
          cat leveldb-results.txt
          echo "=========================="
          
          extract_ops() {
            local bench=$1
            # Use grep without ^ to match anywhere in line, then get micros/op value
            local line=$(grep -E "^[[:space:]]*$bench[[:space:]]*:" leveldb-results.txt | head -1)
            echo "DEBUG: Looking for '$bench', found line: '$line'" >&2
            
            if [ -n "$line" ]; then
              # Extract the number before "micros/op"
              local micros=$(echo "$line" | grep -oP '[\d.]+(?=\s*micros/op)' | head -1)
              echo "DEBUG: Extracted micros: '$micros'" >&2
              
              if [ -n "$micros" ] && [ "$micros" != "0" ]; then
                # Convert micros/op to ops/s: 1,000,000 / micros
                echo "scale=0; 1000000 / $micros" | bc
              else
                echo "N/A"
              fi
            else
              echo "N/A"
            fi
          }
          
          FILLSEQ=$(extract_ops "fillseq")
          FILLRANDOM=$(extract_ops "fillrandom")
          READSEQ=$(extract_ops "readseq")
          READRANDOM=$(extract_ops "readrandom")
          
          echo "fillseq=$FILLSEQ" >> $GITHUB_OUTPUT
          echo "fillrandom=$FILLRANDOM" >> $GITHUB_OUTPUT
          echo "readseq=$READSEQ" >> $GITHUB_OUTPUT
          echo "readrandom=$READRANDOM" >> $GITHUB_OUTPUT
          
          echo "### LevelDB Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat leveldb-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: leveldb-results
          path: leveldb-results.txt

  # ============================================================================
  # RocksDB Benchmark (optional)
  # ============================================================================
  rocksdb:
    name: RocksDB Benchmark
    runs-on: ubuntu-latest
    continue-on-error: true
    if: github.event.inputs.compare_dbs != 'false'
    outputs:
      fillseq: ${{ steps.parse.outputs.fillseq }}
      fillrandom: ${{ steps.parse.outputs.fillrandom }}
      readseq: ${{ steps.parse.outputs.readseq }}
      readrandom: ${{ steps.parse.outputs.readrandom }}
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libgflags-dev libsnappy-dev \
               zlib1g-dev libbz2-dev liblz4-dev libzstd-dev

      - name: Cache RocksDB
        id: cache-rocksdb
        uses: actions/cache@v4
        with:
          path: rocksdb
          key: rocksdb-build-v8.10.0-${{ runner.os }}

      - name: Build RocksDB
        if: steps.cache-rocksdb.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch v8.10.0 https://github.com/facebook/rocksdb.git
          cd rocksdb
          make db_bench -j$(nproc)

      - name: Run Benchmark
        run: |
          cd rocksdb
          ./db_bench --benchmarks=fillseq,fillrandom,readseq,readrandom \
                     --num=${{ env.NUM_OPS }} \
                     --value_size=${{ env.VALUE_SIZE }} 2>&1 | tee ../rocksdb-results.txt

      - name: Parse Results
        id: parse
        run: |
          FILLSEQ=$(grep "^fillseq" rocksdb-results.txt | awk '{print $5}' || echo "N/A")
          FILLRANDOM=$(grep "^fillrandom" rocksdb-results.txt | awk '{print $5}' || echo "N/A")
          READSEQ=$(grep "^readseq" rocksdb-results.txt | awk '{print $5}' || echo "N/A")
          READRANDOM=$(grep "^readrandom" rocksdb-results.txt | awk '{print $5}' || echo "N/A")
          
          echo "fillseq=$FILLSEQ" >> $GITHUB_OUTPUT
          echo "fillrandom=$FILLRANDOM" >> $GITHUB_OUTPUT
          echo "readseq=$READSEQ" >> $GITHUB_OUTPUT
          echo "readrandom=$READRANDOM" >> $GITHUB_OUTPUT
          
          echo "### RocksDB Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat rocksdb-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: rocksdb-results
          path: rocksdb-results.txt

  # ============================================================================
  # Summary Report
  # ============================================================================
  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [rapidodb, leveldb, rocksdb]
    if: always() && needs.rapidodb.result == 'success'
    steps:
      - name: Download All Results
        uses: actions/download-artifact@v4
        with:
          path: results

      - name: Generate Comparison Report
        run: |
          echo "# ðŸ“Š Benchmark Comparison Report" > report.md
          echo "" >> report.md
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> report.md
          echo "**Operations:** ${{ env.NUM_OPS }}" >> report.md
          echo "**Value Size:** ${{ env.VALUE_SIZE }} bytes" >> report.md
          echo "**Runner:** GitHub Actions (ubuntu-latest)" >> report.md
          echo "" >> report.md
          
          echo "## Results Summary" >> report.md
          echo "" >> report.md
          echo "| Workload | RapidoDB | LevelDB | RocksDB |" >> report.md
          echo "|:---------|:---------|:--------|:--------|" >> report.md
          echo "| fillseq | ${{ needs.rapidodb.outputs.fillseq }} ops/s | ${{ needs.leveldb.outputs.fillseq }} ops/s | ${{ needs.rocksdb.outputs.fillseq }} ops/s |" >> report.md
          echo "| fillrandom | ${{ needs.rapidodb.outputs.fillrandom }} ops/s | ${{ needs.leveldb.outputs.fillrandom }} ops/s | ${{ needs.rocksdb.outputs.fillrandom }} ops/s |" >> report.md
          echo "| readseq | ${{ needs.rapidodb.outputs.readseq }} ops/s | ${{ needs.leveldb.outputs.readseq }} ops/s | ${{ needs.rocksdb.outputs.readseq }} ops/s |" >> report.md
          echo "| readrandom | ${{ needs.rapidodb.outputs.readrandom }} ops/s | ${{ needs.leveldb.outputs.readrandom }} ops/s | ${{ needs.rocksdb.outputs.readrandom }} ops/s |" >> report.md
          echo "" >> report.md
          
          echo "## Notes" >> report.md
          echo "" >> report.md
          echo "- RapidoDB prioritizes simplicity and zero dependencies over raw performance" >> report.md
          echo "- LevelDB and RocksDB are highly optimized C++ implementations" >> report.md
          echo "- RapidoDB offers: zero dependencies, 4MB binary, 5-second build time" >> report.md
          echo "- Results may vary based on GitHub Actions runner availability" >> report.md
          echo "" >> report.md
          
          echo "## Full Results" >> report.md
          echo "" >> report.md
          echo "<details>" >> report.md
          echo "<summary>RapidoDB Full Output</summary>" >> report.md
          echo "" >> report.md
          echo '```' >> report.md
          cat results/rapidodb-results/rapidodb-results.txt >> report.md || echo "Not available"
          echo '```' >> report.md
          echo "</details>" >> report.md
          echo "" >> report.md
          
          if [ -f results/leveldb-results/leveldb-results.txt ]; then
            echo "<details>" >> report.md
            echo "<summary>LevelDB Full Output</summary>" >> report.md
            echo "" >> report.md
            echo '```' >> report.md
            cat results/leveldb-results/leveldb-results.txt >> report.md
            echo '```' >> report.md
            echo "</details>" >> report.md
            echo "" >> report.md
          fi
          
          if [ -f results/rocksdb-results/rocksdb-results.txt ]; then
            echo "<details>" >> report.md
            echo "<summary>RocksDB Full Output</summary>" >> report.md
            echo "" >> report.md
            echo '```' >> report.md
            cat results/rocksdb-results/rocksdb-results.txt >> report.md
            echo '```' >> report.md
            echo "</details>" >> report.md
          fi
          
          cat report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-report
          path: report.md

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true  # Don't fail workflow if comment fails (e.g., fork PRs)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Benchmark Comparison Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }

  # ============================================================================
  # Quick Benchmark (RapidoDB only, for PRs)
  # ============================================================================
  quick-bench:
    name: Quick Benchmark
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && !contains(github.event.pull_request.title, '[full-benchmark]')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build and Run Quick Benchmark
        run: |
          go build -o rapidodb-bench ./cmd/bench
          echo "### Quick Benchmark (10K ops)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ./rapidodb-bench --mode all --num 10000 2>&1 | tee -a $GITHUB_STEP_SUMMARY
